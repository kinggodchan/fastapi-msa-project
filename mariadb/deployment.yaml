apiVersion: v1
kind: ConfigMap
metadata:
  name: mariadb-initdb-config
data:
  init.sql: |
    # 1. config.py가 찾는 기본 DB 생성
    CREATE DATABASE IF NOT EXISTS fastapi_db;
    CREATE DATABASE IF NOT EXISTS fcgidb;
    CREATE DATABASE IF NOT EXISTS boarddb;
    
    # 2. config.py에 적힌 정보와 똑같은 사용자 생성 (P@ssw0rd)
    # %40은 URL 인코딩이므로 실제 비밀번호는 @ 입니다.
    CREATE USER IF NOT EXISTS 'test01'@'%' IDENTIFIED BY 'P@ssw0rd';
    
    # 3. 모든 서비스용 DB에 대해 권한 부여
    GRANT ALL PRIVILEGES ON fastapi_db.* TO 'test01'@'%';
    GRANT ALL PRIVILEGES ON fcgidb.* TO 'test01'@'%';
    GRANT ALL PRIVILEGES ON boarddb.* TO 'test01'@'%';
    
    FLUSH PRIVILEGES;
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mariadb
spec:
  selector:
    matchLabels: { app: mariadb }
  template:
    metadata:
      labels: { app: mariadb }
    spec:
      containers:
      - name: mariadb
        image: mariadb:11
        env:
        - name: MARIADB_ROOT_PASSWORD
          value: "rootpass"
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: init-sql
          mountPath: /docker-entrypoint-initdb.d
      volumes:
      - name: init-sql
        configMap:
          name: mariadb-initdb-config
---
apiVersion: v1
kind: Service
metadata:
  name: mysql  # <--- 핵심: 코드가 찾는 'mysql'이라는 이름을 서비스 이름으로 설정
spec:
  selector: { app: mariadb }
  ports:
  - port: 3306
    targetPort: 3306
